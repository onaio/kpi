# Generated by Django 2.2.7 on 2020-02-25 19:49

import json
from django.contrib.postgres.fields.jsonb import JSONField as JSONBField
from django.db import migrations, models
import kpi.fields.kpi_uid
import kpi.models.asset_file
import kpi.models.import_export_task
import private_storage.fields
import private_storage.storage.s3boto3


NULL_CHAR = '\\u0000'


def forwards(apps, schema_editor):
    model_fields = [
        ('Asset', '_deployment_data'),
        ('Asset', 'content'),
        ('Asset', 'summary'),
        ('AssetSnapshot', 'details'),
        ('AssetSnapshot', 'source'),
        ('ExportTask', 'data'),
        ('ExportTask', 'messages'),
        ('ImportTask', 'data'),
        ('ImportTask', 'messages'),
    ]
    print('\n {} | {}'.format('Scanned'.ljust(22), '# records need fixing'))
    for (modelname, modelfield) in model_fields:
        # e.g. Asset
        orm_model = apps.get_model('kpi', modelname)
        qparams = {('{}__contains'.format(modelfield)): NULL_CHAR}
        # e.g. Asset.objects.filter(content__contains=NULL_CHAR)
        records_with_null_chars = orm_model.objects.filter(**qparams)
        changed_records = []
        for record in records_with_null_chars:
            unfixed = getattr(record, modelfield)
            dumped = json.dumps(unfixed).replace(NULL_CHAR, '')
            fixed = json.loads(dumped)
            setattr(record, modelfield, fixed)
            changed_records.append(record)
        model_name_plus_field = '{}.{}'.format(modelname, modelfield).ljust(22)
        print(' {} | {}'.format(model_name_plus_field, len(changed_records)))
        if len(changed_records) > 0:
            orm_model.objects.bulk_update(changed_records, [modelfield])
    print('''
    Database is ready.
    Proceeding with migration 0024 (text -> jsonb)

    This might take a while depending on your database size
    ''')


def noop(*args, **kwargs):
    pass


class Migration(migrations.Migration):

    dependencies = [
        ('kpi', '0023_partial_permissions'),
    ]

    operations = [
        migrations.RunPython(forwards, noop),
        migrations.AlterField(
            model_name='asset',
            name='_deployment_data',
            field=JSONBField(default=dict),
        ),
        migrations.AlterField(
            model_name='asset',
            name='content',
            field=JSONBField(null=True),
        ),
        migrations.AlterField(
            model_name='asset',
            name='summary',
            field=JSONBField(default=dict, null=True),
        ),
        migrations.AlterField(
            model_name='assetsnapshot',
            name='details',
            field=JSONBField(default=dict),
        ),
        migrations.AlterField(
            model_name='assetsnapshot',
            name='source',
            field=JSONBField(null=True),
        ),
        migrations.AlterField(
            model_name='assetversion',
            name='_deployment_data',
            field=JSONBField(default=dict),
        ),
        migrations.AlterField(
            model_name='exporttask',
            name='data',
            field=JSONBField(),
        ),
        migrations.AlterField(
            model_name='exporttask',
            name='messages',
            field=JSONBField(default=dict),
        ),
        migrations.AlterField(
            model_name='importtask',
            name='data',
            field=JSONBField(),
        ),
        migrations.AlterField(
            model_name='importtask',
            name='messages',
            field=JSONBField(default=dict),
        ),
    ]
